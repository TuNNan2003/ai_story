# Grandma - AI 故事创作平台

Grandma 是一个前后端分离的 AI 故事创作应用，用户可以与 AI 协作创作完整的故事。系统提供了智能对话、流式响应、RAG 增强生成等核心功能，特别针对长篇故事创作场景进行了深度优化，支持人物设定、世界观和情节的一致性维护。

## 📋 目录

- [项目概述](#项目概述)
- [核心特性](#核心特性)
- [技术架构](#技术架构)
- [快速开始](#快速开始)
- [项目结构](#项目结构)
- [功能演进](#功能演进)
- [技术栈](#技术栈)

## 📖 项目概述

Grandma 是一个完整的 AI 故事创作平台，采用前后端分离架构，后端使用 Go 语言和 Gin 框架构建，前端使用 React 和 Vite 开发。系统支持多种大语言模型接入，包括 OpenAI 和 Anthropic 等，通过统一的接口抽象实现了模型的无缝切换。系统核心功能包括实时流式响应、打字机效果展示、完整的 Markdown 渲染、对话历史管理、故事保存和管理等。

系统设计支持两种工作模式，以适应不同的使用场景。普通对话模式提供了简洁的对话界面，适合日常的 AI 对话场景，用户可以创建多个对话，每个对话都有独立的 ID，系统会自动管理对话历史和上下文。灵感模式则专门为长篇故事创作进行了优化，不仅提供了创作项目管理功能，还实现了右侧面板实时展示 AI 创作内容，支持多文档管理和编辑功能，通过 RAG 技术实现了人物设定、世界观和情节的一致性维护。

在数据管理方面，系统实现了完整的数据持久化方案，后端使用 SQLite 数据库存储所有对话、文档、创作和故事数据，通过 GORM 框架简化了数据库操作。系统还实现了完整的多用户数据隔离机制，每个用户都有唯一的用户 ID，确保不同用户之间的数据完全隔离。前端使用 localStorage 保存用户设置，包括用户 ID、侧边栏宽度等，确保用户多次打开网页时保持一致的体验。

## ✨ 核心特性

系统提供了全面的智能对话能力，通过统一接口支持多种大语言模型，实现了实时流式返回 AI 响应的能力。当用户发送消息后，后端会调用大模型 API，并将响应以流式方式返回给前端，前端实时接收并展示，配合打字机效果组件，AI 的响应会逐字显示，为用户提供流畅的交互体验。系统支持完整的 Markdown 渲染能力，包括标题、列表、代码块、表格、引用块、链接和图片等所有 Markdown 元素，并且所有样式都已适配深色主题，确保在深色背景下有良好的可读性。

在对话管理方面，系统实现了完整的对话历史管理功能。每个对话都有独立的对话 ID，对话中的每条消息都有独立的文档 ID，系统会自动管理对话和文档的关联关系。用户可以创建新对话，查看历史对话，重命名对话，删除对话等。当用户切换对话时，系统会自动加载对话的历史消息，历史消息会一次性完整显示，不使用打字机效果，而新消息则使用打字机效果，这种设计既保证了历史消息的快速加载，又为新消息提供了良好的交互体验。

系统还实现了智能的对话标题生成功能。当用户创建新对话或切换对话时，如果对话还没有自定义标题，系统会自动将对话中的所有用户输入发送给大模型，让大模型生成一个合适的标题，然后自动为对话命名。这个功能大大提升了用户体验，用户不需要手动为每个对话命名，系统会自动生成有意义的标题。

在故事管理方面，系统提供了完整的故事保存和管理功能。用户可以将 AI 生成的内容保存为故事，系统会为每个故事计算一个唯一的特征值（使用 SHA-256 哈希），避免重复内容多次保存。用户可以查看故事列表，编辑故事标题和内容，删除故事等。故事内容支持完整的 Markdown 格式，用户可以在专门的查看页面中查看故事，系统会以 Markdown 格式渲染故事内容。

灵感模式是系统的核心特性之一，专门为长篇故事创作进行了优化。在灵感模式下，界面采用三栏布局，左侧是创作历史，中间是聊天区域，右侧是文档展示和编辑区域。用户可以创建多个创作项目，每个项目包含多个文档片段，系统会在右侧面板实时展示 AI 生成的内容。当 AI 响应完成或用户选择查看历史文档时，右侧面板会显示对应的内容，用户可以点击编辑按钮进入编辑模式，修改内容后点击保存按钮将修改保存到后端。文档列表支持新增、重命名、删除等操作，用户可以灵活管理创作过程中的各个文档片段。

系统还实现了 RAG（检索增强生成）功能，这是针对长篇故事创作的重要优化。RAG 功能通过向量检索技术实现了上下文增强，当用户提出新的创作要求时，系统会从历史文档中检索相关的信息，包括人物设定、世界观设定、已有情节等，然后将这些信息构建成增强的上下文，与用户查询一起发送给大模型，从而让模型能够基于更丰富的背景信息生成回答，确保新内容与已有内容保持高度一致。RAG 功能采用异步索引机制，所有索引操作都在独立的 goroutine 中执行，不会阻塞主流程，从而保证了系统的响应速度。

## 🏗️ 技术架构

系统采用前后端分离架构，后端使用 Go 语言和 Gin 框架构建，前端使用 React 和 Vite 开发。这种架构设计使得前后端可以独立开发、部署和扩展，提高了系统的灵活性和可维护性。

后端采用经典的分层架构设计，从 HTTP 层开始，通过 Gin 路由器和 CORS 中间件处理所有外部请求。请求经过 Handler 层进行参数验证和响应格式化，Handler 层包含了聊天、对话、文档、创作和故事等多个处理器。业务逻辑集中在 Service 层处理，包括聊天服务、RAG 服务以及其他业务服务。Service 层之下是 Repository 层，负责数据访问抽象，封装了所有数据库操作。最底层是 Model 层，定义了所有业务实体和请求响应结构。整个系统通过这种分层设计实现了清晰的职责分离，每一层都专注于自己的核心功能，上层依赖下层提供的接口，而下层不依赖上层，这种设计使得系统具有良好的可维护性和可扩展性。

前端采用 React 18 作为核心框架，使用 Vite 作为构建工具，提供了快速的开发体验和高效的构建性能。整体架构采用组件化设计，将功能拆分为多个独立的组件，每个组件专注于自己的职责，通过 props 传递数据和回调函数实现组件间的通信。主应用组件负责整体的状态管理和业务逻辑协调，维护了消息列表、对话历史、创作列表、模型列表等核心状态。子组件通过 props 接收数据和回调函数，通过回调函数更新父组件状态。系统使用 React Hooks 进行状态管理，通过 `useState` 管理组件状态，通过 `useEffect` 处理生命周期和副作用，通过 `useRef` 管理需要在异步操作中访问的值，通过 `useCallback` 优化回调函数的性能。

在数据流方面，前端通过 HTTP 请求与后端通信，使用 Server-Sent Events (SSE) 或 Fetch API 的流式读取功能接收后端的流式响应。前端每次请求仅发送当前用户输入的消息内容，不包含历史消息，这样既减少了请求体的大小，又提高了请求速度。后端负责管理对话历史和上下文，从数据库加载历史消息作为上下文发送给大模型，这种设计使得前后端职责清晰，系统更加高效。

## 🚀 快速开始

系统要求后端使用 Go 1.21 或更高版本，前端使用 Node.js 16 或更高版本。安装过程非常简单，首先需要分别启动后端和前端服务。

后端启动过程包括进入后端目录，运行 `go mod download` 安装依赖，然后创建 `.env` 文件配置环境变量，包括服务器端口（默认 8080）、数据库路径（默认 grandma.db）、OpenAI 和 Anthropic 的 API Key 和 Base URL，以及 RAG 相关的配置。配置完成后，运行 `go run main.go` 即可启动后端服务器，服务器将在 `http://localhost:8080` 启动。

前端启动过程包括进入前端目录，运行 `npm install` 安装依赖，然后运行 `npm run dev` 启动开发服务器，前端应用将在 `http://localhost:5173` 启动（Vite 的默认端口）。开发服务器支持热模块替换（HMR），当代码修改时，浏览器会自动刷新，显示最新的更改。

启动完成后，在浏览器访问 `http://localhost:5173`，即可开始使用系统。用户可以在输入框上方的下拉框中选择要使用的大模型，在输入框中输入想法或问题，按 Enter 或点击发送按钮，AI 的响应将以打字机效果逐字显示。用户可以点击左侧历史对话查看之前的对话记录，历史对话消息会一次性完整显示，不使用打字机效果。

## 📁 项目结构

项目采用清晰的目录结构，按照功能进行组织。根目录包含 `backend` 和 `fronend` 两个主要目录，分别存放后端和前端代码。

后端目录采用模块化设计，`config` 目录负责配置管理，`database` 目录处理数据库初始化和迁移，`models` 目录定义了所有业务实体和请求响应结构，`repository` 目录实现了数据访问层，每个业务实体都有对应的 Repository，`services` 目录提供了基础服务，包括模型提供者、Embedding、文本切片和向量存储等，`modules` 目录包含了所有业务模块，包括聊天、对话管理、文档管理、创作管理、故事管理和 RAG 服务等，`utils` 目录提供了通用工具函数，包括 ID 生成和哈希计算等。

前端目录采用组件化设计，`src` 目录包含了所有源代码，`components` 子目录包含了所有 React 组件。主应用组件 `App.jsx` 位于 `src` 目录的根目录，负责整体的状态管理和业务逻辑协调。入口文件 `main.jsx` 负责初始化 React 应用，挂载到 DOM。组件目录按照功能进行了细分，聊天相关的组件包括 `ChatContainer`、`MessageList`、`Message` 等，Markdown 渲染相关的组件包括 `MarkdownRenderer` 和 `Typewriter`，输入相关的组件包括 `InputArea` 和 `EnhancedInputArea`，历史管理相关的组件包括 `ConversationHistory` 和 `WorkHistory`，文档管理相关的组件包括 `WorkDocumentList` 和 `InspirationDocumentView`，对话框组件包括 `StoryEditDialog`、`StoryViewDialog` 和 `DeleteConfirmDialog` 等。

## 📈 功能演进

系统从最初的简单对话功能开始，逐步演进为功能完整的 AI 故事创作平台。v0.1 版本实现了基础的对话功能，包括类似 GPT 的页面 UI 风格、打字机效果、流式响应接收、Markdown 渲染等核心功能。v0.2 版本优化了 UI 设计，包括输入框样式优化、页面配色优化、对话列表支持隐藏和展开、支持新对话按钮、历史对话加载等功能。v0.3 版本增加了对话重命名和删除功能，以及智能标题生成功能。v0.4 版本增加了故事管理功能，用户可以保存和管理故事。v1.0 版本引入了灵感模式，专门为长篇故事创作进行了优化，包括三栏布局、右侧面板展示、文档列表管理等功能。v2.0 版本实现了 RAG 功能，通过向量检索技术实现了上下文增强，显著提升了长篇故事创作的一致性和连贯性。v2.1 版本增加了文档编辑功能，用户可以在右侧面板直接编辑和保存文档内容。

每个版本的开发都遵循了前后端分离的原则，前端专注于用户界面和交互体验，后端专注于业务逻辑和数据处理。系统采用了微服务架构，后端拆分为多个模块，每个模块专注于自己的功能，这种设计使得系统具有良好的可维护性和可扩展性。前端采用组件化设计，将功能拆分为多个独立的组件，每个组件专注于自己的职责，通过 props 传递数据和回调函数实现组件间的通信，这种设计使得前端代码更加清晰，易于维护和扩展。

## 🛠️ 技术栈

系统采用了现代化的技术栈，后端使用 Go 语言作为主要开发语言，Go 语言具有出色的并发性能和简洁的语法，非常适合构建高性能的 Web 服务。Gin 框架提供了轻量级的 Web 框架，具有高性能和丰富的中间件支持。GORM 框架简化了数据库操作，提供了强大的 ORM 功能。SQLite 数据库提供了轻量级的数据存储方案，适合中小型应用。Server-Sent Events (SSE) 技术实现了流式响应，使得系统能够实时返回 AI 响应。

前端使用 React 18 作为核心框架，React 提供了强大的组件化能力和丰富的生态系统。Vite 作为构建工具，提供了快速的开发体验和高效的构建性能，支持热模块替换（HMR），大大提高了开发效率。react-markdown 库提供了完整的 Markdown 解析和渲染能力，remark-gfm 插件支持 GitHub 风格的 Markdown，包括表格、删除线、任务列表等扩展语法。

在数据管理方面，系统使用 SQLite 作为数据库，SQLite 是一个轻量级的嵌入式数据库，不需要单独的数据库服务器，非常适合中小型应用。GORM 框架提供了强大的 ORM 功能，包括自动迁移、关联查询、事务处理等。系统还实现了完整的多用户数据隔离机制，通过用户 ID 确保不同用户之间的数据完全隔离。

在 RAG 功能实现方面，系统使用了向量检索技术，通过 Embedding API 将文本转换为数值向量，然后使用余弦相似度算法计算向量相似度，从历史文档中检索相关信息。系统实现了智能的文本切片策略，优先按段落分割以保持语义完整性，当段落过长时自动切换到固定大小分割，并且在 chunk 之间保留重叠区域以避免语义边界丢失。系统还实现了时间衰减因子机制，较新的内容会被赋予更高的权重，确保系统优先使用最新的相关信息。

## 📝 许可证

本项目采用 MIT 许可证。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

**注意**：本项目仍在积极开发中，API 和功能可能会有变化。建议在生产环境使用前进行充分测试。
